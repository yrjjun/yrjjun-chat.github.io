<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密聊天</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.2.1/jsencrypt.min.js"></script>
    <style>
        body { margin: 20px; font-family: Arial; }
        .container { max-width: 800px; margin: 0 auto; }
        .chat-box { 
            height: 300px; 
            border: 1px solid #ccc; 
            overflow-y: auto; 
            margin: 10px 0;
            padding: 10px;
        }
        .message { margin: 5px 0; padding: 5px; }
        .received { background: #e9ecef; }
        .sent { background: #d4edda; margin-left: 20%; }
        textarea { width: 100%; margin: 10px 0; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>加密聊天</h2>
        
        <div>
            <h3>密钥管理</h3>
            <button onclick="generateKeys()">生成新的密钥对</button>
            <div id="myKeys" style="word-break: break-all;"></div>
        </div>

        <div>
            <h3>订阅主题</h3>
            <input type="text" id="subTopic" placeholder="输入要订阅的主题(公钥)" style="width: 300px;">
            <button onclick="subscribe()">订阅</button>
        </div>

        <div>
            <h3>发送消息</h3>
            <input type="text" id="pubTopic" placeholder="输入对方的公钥" style="width: 300px;">
            <br>
            <textarea id="message" rows="3" placeholder="输入消息"></textarea>
            <br>
            <button onclick="sendMessage()">发送</button>
        </div>

        <div class="chat-box" id="chatBox"></div>
    </div>

    <script>
        let client;
        let myPrivateKey = '';
        let myPublicKey = '';

        // 连接MQTT
        function connectMQTT() {
            client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            
            client.on('connect', () => {
                console.log('Connected to MQTT broker');
                showMessage('系统', '已连接到服务器');
            });

            client.on('message', (topic, message) => {
                try {
                    const decrypt = new JSEncrypt();
                    decrypt.setPrivateKey(myPrivateKey);
                    const decrypted = decrypt.decrypt(message.toString());
                    if(decrypted) {
                        showMessage('收到', decrypted);
                    }
                } catch (error) {
                    console.error('解密失败:', error);
                }
            });
        }

        // 生成密钥对
        function generateKeys() {
            const encrypt = new JSEncrypt({default_key_size: 1024});
            encrypt.getKey();
            myPrivateKey = encrypt.getPrivateKey();
            myPublicKey = encrypt.getPublicKey();
            
            document.getElementById('myKeys').innerHTML = `
                <p><strong>私钥:</strong><br><small>${myPrivateKey}</small></p>
                <p><strong>公钥(分享给他人):</strong><br><small>${myPublicKey}</small></p>
            `;
        }

        // 订阅主题
        function subscribe() {
            const topic = document.getElementById('subTopic').value.trim();
            if(!topic) {
                alert('请输入要订阅的主题');
                return;
            }
            client.subscribe(topic);
            showMessage('系统', '已订阅主题: ' + topic);
        }

        // 发送消息
        function sendMessage() {
            const topic = document.getElementById('pubTopic').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if(!topic || !message) {
                alert('请输入完整的发送信息');
                return;
            }

            const encrypt = new JSEncrypt();
            encrypt.setPublicKey(topic);
            const encrypted = encrypt.encrypt(message);

            if(encrypted) {
                client.publish(topic, encrypted);
                showMessage('发送', message);
                document.getElementById('message').value = '';
            } else {
                alert('加密失败');
            }
        }

        // 显示消息
        function showMessage(type, content) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type === '发送' ? 'sent' : 'received'}`;
            messageDiv.textContent = `${type}: ${content}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 页面加载时连接MQTT
        connectMQTT();
    </script>
</body>
</html>
